<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="title" content="Magnet Power Puzzle">
    <meta name="description" content="Solve puzzles using magnetic attraction and repulsion">
    <meta name="content-type" content="game">
    <meta name="subject" content="science">
    <meta name="grade-level" content="3,4,5">
    <meta name="difficulty" content="hard">
    <meta name="skills" content="Physics,Magnetism,Problem Solving,Forces">
    <meta name="estimated-time" content="15-20 mins">
    <title>Magnet Power Puzzle - Learning Adventures</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(135deg, rgba(229,57,53,0.3), rgba(33,150,243,0.3));
            padding: 20px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .game-header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #E53935, #fff, #2196F3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .stat {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .level-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .level-info h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .level-info p {
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
        }

        .puzzle-area {
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a3a 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .puzzle-grid {
            display: grid;
            gap: 5px;
            margin: 0 auto;
            max-width: 500px;
        }

        .grid-cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            position: relative;
            transition: all 0.3s;
        }

        .grid-cell.wall {
            background: #333;
        }

        .grid-cell.goal {
            background: linear-gradient(135deg, rgba(76,175,80,0.3), rgba(139,195,74,0.3));
            border: 2px dashed #4CAF50;
            animation: goalPulse 2s infinite;
        }

        @keyframes goalPulse {
            0%, 100% { box-shadow: inset 0 0 10px rgba(76,175,80,0.3); }
            50% { box-shadow: inset 0 0 20px rgba(76,175,80,0.5); }
        }

        .magnet {
            position: absolute;
            width: 90%;
            height: 90%;
            border-radius: 10px;
            display: flex;
            cursor: grab;
            transition: transform 0.3s, box-shadow 0.3s;
            z-index: 10;
        }

        .magnet:hover {
            transform: scale(1.05);
        }

        .magnet.dragging {
            cursor: grabbing;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .magnet .pole {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .magnet .pole.north {
            background: linear-gradient(135deg, #E53935, #C62828);
            border-radius: 10px 0 0 10px;
            color: white;
        }

        .magnet .pole.south {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            border-radius: 0 10px 10px 0;
            color: white;
        }

        .magnet.vertical .pole.north {
            border-radius: 10px 10px 0 0;
        }

        .magnet.vertical .pole.south {
            border-radius: 0 0 10px 10px;
        }

        .magnet.vertical {
            flex-direction: column;
        }

        .ball {
            position: absolute;
            width: 70%;
            height: 70%;
            background: radial-gradient(circle at 30% 30%, #FFD700, #B8860B);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.5s ease;
            z-index: 5;
        }

        .ball.magnetic {
            background: radial-gradient(circle at 30% 30%, #C0C0C0, #808080);
        }

        .force-line {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .force-line.attract {
            border: 2px dashed #4CAF50;
        }

        .force-line.repel {
            border: 2px dashed #f44336;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }

        .control-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .magnet-inventory {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .inventory-magnet {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .inventory-magnet:hover {
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-3px);
        }

        .inventory-magnet.selected {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .inventory-magnet .preview {
            width: 60px;
            height: 30px;
            display: flex;
            border-radius: 5px;
            overflow: hidden;
        }

        .inventory-magnet .preview .pole {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
        }

        .info-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-panel h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #FFD700;
        }

        .magnet-rules {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .rule {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .rule .demo {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .rule p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 3px solid rgba(255,255,255,0.1);
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content h2 {
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .modal-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .modal-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #E53935, #2196F3);
            color: white;
            transition: all 0.3s;
            margin: 5px;
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }

        .stars {
            font-size: 3em;
            margin: 15px 0;
        }

        .celebration {
            position: fixed;
            font-size: 3em;
            animation: celebrationFloat 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 1001;
        }

        @keyframes celebrationFloat {
            0% { opacity: 1; transform: scale(0.5) translateY(0); }
            50% { transform: scale(1.2) translateY(-50px); }
            100% { opacity: 0; transform: scale(1) translateY(-150px); }
        }

        @media (max-width: 600px) {
            .game-header h1 {
                font-size: 1.6em;
            }

            .grid-cell {
                font-size: 1.5em;
            }

            .puzzle-grid {
                gap: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <h1>üß≤ Magnet Power Puzzle</h1>
            <p>Use magnetic forces to guide the ball to the goal!</p>
            <div class="stats-bar">
                <div class="stat">üìä Level: <span id="level">1</span>/8</div>
                <div class="stat">‚≠ê Score: <span id="score">0</span></div>
                <div class="stat">üîÑ Moves: <span id="moves">0</span></div>
            </div>
        </header>

        <div class="level-info">
            <h2 id="levelTitle">Level 1: First Attraction</h2>
            <p id="levelDescription">Place the magnet to attract the metal ball to the goal.</p>
        </div>

        <div class="puzzle-area">
            <div class="puzzle-grid" id="puzzleGrid"></div>
        </div>

        <div class="magnet-inventory" id="magnetInventory"></div>

        <div class="controls">
            <button class="control-btn primary" onclick="simulatePhysics()">‚ñ∂Ô∏è Activate Magnets</button>
            <button class="control-btn secondary" onclick="resetLevel()">üîÑ Reset Level</button>
        </div>

        <div class="info-panel">
            <h3>üß≤ Magnet Rules</h3>
            <div class="magnet-rules">
                <div class="rule">
                    <div class="demo">üî¥üîµ ‚Üê ‚Üí üîµüî¥</div>
                    <p><strong>Opposites Attract!</strong><br>North (N) attracts South (S)</p>
                </div>
                <div class="rule">
                    <div class="demo">üî¥üîµ ‚Üî üî¥üîµ</div>
                    <p><strong>Same Poles Repel!</strong><br>N repels N, S repels S</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Modal -->
    <div class="modal active" id="startModal">
        <div class="modal-content">
            <h2>üß≤ Magnet Power Puzzle</h2>
            <p>Welcome, young physicist! Learn about magnetism by solving puzzles.</p>
            <p><strong>How to play:</strong></p>
            <p>1. Drag magnets from inventory onto the grid<br>
            2. Position them to push or pull the ball<br>
            3. Click "Activate Magnets" to see the forces work!<br>
            4. Get the ball to the green goal!</p>
            <p><em>Remember: Opposite poles attract, same poles repel!</em></p>
            <button class="modal-btn" onclick="startGame()">Start Puzzling!</button>
        </div>
    </div>

    <!-- Level Complete Modal -->
    <div class="modal" id="completeModal">
        <div class="modal-content">
            <h2>üéâ Level Complete!</h2>
            <div class="stars" id="starsDisplay">‚≠ê‚≠ê‚≠ê</div>
            <p id="completeText"></p>
            <p id="completeFact"></p>
            <button class="modal-btn" onclick="nextLevel()">Next Level ‚Üí</button>
        </div>
    </div>

    <!-- Game Complete Modal -->
    <div class="modal" id="gameCompleteModal">
        <div class="modal-content">
            <h2>üèÜ Magnet Master!</h2>
            <p>Amazing! You've completed all the magnet puzzles!</p>
            <p id="finalStats"></p>
            <button class="modal-btn" onclick="startGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Level definitions
        const levels = [
            {
                title: 'Level 1: First Attraction',
                description: 'Place the magnet to attract the metal ball to the goal.',
                gridSize: 5,
                ball: { x: 0, y: 2, magnetic: true },
                goal: { x: 4, y: 2 },
                walls: [],
                magnets: [{ orientation: 'horizontal' }],
                placedMagnets: [],
                fact: 'Magnets have been used for over 2,000 years! Ancient Greeks discovered magnetic stones called lodestones.'
            },
            {
                title: 'Level 2: Push Away',
                description: 'Use repulsion to push the ball to the goal!',
                gridSize: 5,
                ball: { x: 2, y: 0, magnetic: true },
                goal: { x: 2, y: 4 },
                walls: [],
                magnets: [{ orientation: 'vertical' }],
                placedMagnets: [],
                fact: 'The Earth itself is a giant magnet! That\'s why compasses always point north.'
            },
            {
                title: 'Level 3: Around the Corner',
                description: 'Navigate the ball around the wall using magnets.',
                gridSize: 6,
                ball: { x: 0, y: 0, magnetic: true },
                goal: { x: 5, y: 5 },
                walls: [{x: 2, y: 0}, {x: 2, y: 1}, {x: 2, y: 2}, {x: 2, y: 3}],
                magnets: [{ orientation: 'horizontal' }, { orientation: 'vertical' }],
                placedMagnets: [],
                fact: 'MRI machines in hospitals use powerful magnets to take pictures inside your body without surgery!'
            },
            {
                title: 'Level 4: Double Trouble',
                description: 'Use two magnets to guide the ball through the maze.',
                gridSize: 6,
                ball: { x: 0, y: 3, magnetic: true },
                goal: { x: 5, y: 3 },
                walls: [{x: 2, y: 2}, {x: 2, y: 3}, {x: 2, y: 4}, {x: 4, y: 1}, {x: 4, y: 2}, {x: 4, y: 3}],
                magnets: [{ orientation: 'horizontal' }, { orientation: 'horizontal' }],
                placedMagnets: [],
                fact: 'Maglev trains use magnets to float above the tracks, allowing them to travel at over 300 mph!'
            },
            {
                title: 'Level 5: Magnetic Field',
                description: 'Plan your magnet placement carefully!',
                gridSize: 7,
                ball: { x: 0, y: 3, magnetic: true },
                goal: { x: 6, y: 3 },
                walls: [{x: 2, y: 1}, {x: 2, y: 2}, {x: 2, y: 4}, {x: 2, y: 5}, {x: 4, y: 1}, {x: 4, y: 2}, {x: 4, y: 4}, {x: 4, y: 5}],
                magnets: [{ orientation: 'vertical' }, { orientation: 'vertical' }],
                placedMagnets: [],
                fact: 'Some animals like sea turtles and birds can sense Earth\'s magnetic field to navigate during migration!'
            },
            {
                title: 'Level 6: Zigzag Path',
                description: 'Create a zigzag path using attract and repel forces.',
                gridSize: 7,
                ball: { x: 0, y: 0, magnetic: true },
                goal: { x: 6, y: 6 },
                walls: [{x: 1, y: 1}, {x: 2, y: 1}, {x: 3, y: 3}, {x: 4, y: 3}, {x: 5, y: 5}],
                magnets: [{ orientation: 'horizontal' }, { orientation: 'vertical' }, { orientation: 'horizontal' }],
                placedMagnets: [],
                fact: 'Refrigerator magnets work because the fridge door is made of steel, which is attracted to magnets!'
            },
            {
                title: 'Level 7: The Gauntlet',
                description: 'Navigate through a challenging maze of walls.',
                gridSize: 8,
                ball: { x: 0, y: 4, magnetic: true },
                goal: { x: 7, y: 4 },
                walls: [
                    {x: 2, y: 2}, {x: 2, y: 3}, {x: 2, y: 4}, {x: 2, y: 5},
                    {x: 4, y: 3}, {x: 4, y: 4}, {x: 4, y: 5}, {x: 4, y: 6},
                    {x: 6, y: 2}, {x: 6, y: 3}, {x: 6, y: 4}, {x: 6, y: 5}
                ],
                magnets: [{ orientation: 'vertical' }, { orientation: 'vertical' }, { orientation: 'vertical' }],
                placedMagnets: [],
                fact: 'The strongest magnets on Earth are in laboratories and are 500,000 times stronger than fridge magnets!'
            },
            {
                title: 'Level 8: Master Challenge',
                description: 'Use everything you\'ve learned to complete this final puzzle!',
                gridSize: 8,
                ball: { x: 0, y: 0, magnetic: true },
                goal: { x: 7, y: 7 },
                walls: [
                    {x: 1, y: 2}, {x: 2, y: 2}, {x: 3, y: 2},
                    {x: 5, y: 2}, {x: 5, y: 3}, {x: 5, y: 4},
                    {x: 2, y: 5}, {x: 3, y: 5}, {x: 4, y: 5},
                    {x: 6, y: 5}, {x: 6, y: 6}
                ],
                magnets: [
                    { orientation: 'horizontal' },
                    { orientation: 'vertical' },
                    { orientation: 'horizontal' },
                    { orientation: 'vertical' }
                ],
                placedMagnets: [],
                fact: 'Congratulations! You now understand the basics of magnetism - a fundamental force of the universe!'
            }
        ];

        // Game state
        let gameState = {
            currentLevel: 0,
            score: 0,
            moves: 0,
            selectedMagnet: null,
            ball: null,
            placedMagnets: []
        };

        function initLevel() {
            const level = levels[gameState.currentLevel];
            gameState.ball = { ...level.ball };
            gameState.placedMagnets = [];
            gameState.moves = 0;

            document.getElementById('level').textContent = gameState.currentLevel + 1;
            document.getElementById('levelTitle').textContent = level.title;
            document.getElementById('levelDescription').textContent = level.description;
            document.getElementById('moves').textContent = gameState.moves;

            renderGrid();
            renderInventory();
        }

        function renderGrid() {
            const level = levels[gameState.currentLevel];
            const grid = document.getElementById('puzzleGrid');
            grid.style.gridTemplateColumns = `repeat(${level.gridSize}, 1fr)`;
            grid.innerHTML = '';

            for (let y = 0; y < level.gridSize; y++) {
                for (let x = 0; x < level.gridSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    // Check if wall
                    if (level.walls.some(w => w.x === x && w.y === y)) {
                        cell.classList.add('wall');
                        cell.textContent = 'üß±';
                    }

                    // Check if goal
                    if (level.goal.x === x && level.goal.y === y) {
                        cell.classList.add('goal');
                        cell.textContent = 'üéØ';
                    }

                    // Allow dropping magnets
                    cell.ondragover = (e) => e.preventDefault();
                    cell.ondrop = (e) => dropMagnet(e, x, y);
                    cell.onclick = () => placeMagnetAtCell(x, y);

                    grid.appendChild(cell);
                }
            }

            // Add ball
            renderBall();

            // Add placed magnets
            gameState.placedMagnets.forEach(m => renderPlacedMagnet(m));
        }

        function renderBall() {
            // Remove existing ball
            const existingBall = document.querySelector('.ball');
            if (existingBall) existingBall.remove();

            const level = levels[gameState.currentLevel];
            const grid = document.getElementById('puzzleGrid');
            const cells = grid.children;
            const cellIndex = gameState.ball.y * level.gridSize + gameState.ball.x;
            const cell = cells[cellIndex];

            if (cell) {
                const ball = document.createElement('div');
                ball.className = `ball ${gameState.ball.magnetic ? 'magnetic' : ''}`;
                cell.appendChild(ball);
            }
        }

        function renderInventory() {
            const level = levels[gameState.currentLevel];
            const inventory = document.getElementById('magnetInventory');
            inventory.innerHTML = '';

            const availableMagnets = level.magnets.filter((m, i) =>
                !gameState.placedMagnets.some(p => p.inventoryIndex === i)
            );

            level.magnets.forEach((magnet, index) => {
                const isPlaced = gameState.placedMagnets.some(p => p.inventoryIndex === index);
                if (isPlaced) return;

                const item = document.createElement('div');
                item.className = 'inventory-magnet';
                item.draggable = true;
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="preview" style="flex-direction: ${magnet.orientation === 'vertical' ? 'column' : 'row'}">
                        <div class="pole" style="background: linear-gradient(135deg, #E53935, #C62828);">N</div>
                        <div class="pole" style="background: linear-gradient(135deg, #2196F3, #1565C0);">S</div>
                    </div>
                    <span>${magnet.orientation === 'vertical' ? '‚ÜïÔ∏è' : '‚ÜîÔ∏è'}</span>
                `;
                item.onclick = () => selectMagnet(index);
                item.ondragstart = (e) => {
                    gameState.selectedMagnet = index;
                    item.classList.add('selected');
                };
                inventory.appendChild(item);
            });
        }

        function selectMagnet(index) {
            gameState.selectedMagnet = index;
            document.querySelectorAll('.inventory-magnet').forEach(item => {
                item.classList.toggle('selected', parseInt(item.dataset.index) === index);
            });
        }

        function placeMagnetAtCell(x, y) {
            if (gameState.selectedMagnet === null) return;

            const level = levels[gameState.currentLevel];

            // Check if valid placement
            if (level.walls.some(w => w.x === x && w.y === y)) return;
            if (level.goal.x === x && level.goal.y === y) return;
            if (gameState.ball.x === x && gameState.ball.y === y) return;
            if (gameState.placedMagnets.some(m => m.x === x && m.y === y)) return;

            const magnetDef = level.magnets[gameState.selectedMagnet];
            const placedMagnet = {
                x: x,
                y: y,
                orientation: magnetDef.orientation,
                inventoryIndex: gameState.selectedMagnet
            };

            gameState.placedMagnets.push(placedMagnet);
            gameState.selectedMagnet = null;

            renderGrid();
            renderInventory();
        }

        function dropMagnet(e, x, y) {
            e.preventDefault();
            placeMagnetAtCell(x, y);
        }

        function renderPlacedMagnet(magnet) {
            const level = levels[gameState.currentLevel];
            const grid = document.getElementById('puzzleGrid');
            const cells = grid.children;
            const cellIndex = magnet.y * level.gridSize + magnet.x;
            const cell = cells[cellIndex];

            if (cell && !cell.classList.contains('wall')) {
                const magnetEl = document.createElement('div');
                magnetEl.className = `magnet ${magnet.orientation}`;
                magnetEl.innerHTML = `
                    <div class="pole north">N</div>
                    <div class="pole south">S</div>
                `;
                magnetEl.onclick = (e) => {
                    e.stopPropagation();
                    removeMagnet(magnet);
                };
                cell.appendChild(magnetEl);
            }
        }

        function removeMagnet(magnet) {
            gameState.placedMagnets = gameState.placedMagnets.filter(m => m !== magnet);
            renderGrid();
            renderInventory();
        }

        function simulatePhysics() {
            if (gameState.placedMagnets.length === 0) {
                alert('Place at least one magnet first!');
                return;
            }

            gameState.moves++;
            document.getElementById('moves').textContent = gameState.moves;

            // Calculate forces on ball
            const level = levels[gameState.currentLevel];
            let forceX = 0;
            let forceY = 0;

            gameState.placedMagnets.forEach(magnet => {
                const dx = magnet.x - gameState.ball.x;
                const dy = magnet.y - gameState.ball.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > 0 && distance < 4) {
                    // Attraction force (simplified)
                    const strength = 2 / distance;

                    if (magnet.orientation === 'horizontal') {
                        // North on left, South on right
                        forceX += dx > 0 ? strength : -strength * 0.5;
                    } else {
                        // North on top, South on bottom
                        forceY += dy > 0 ? strength : -strength * 0.5;
                    }
                }
            });

            // Normalize and apply movement
            const newX = Math.round(gameState.ball.x + Math.sign(forceX) * Math.min(Math.abs(forceX), 2));
            const newY = Math.round(gameState.ball.y + Math.sign(forceY) * Math.min(Math.abs(forceY), 2));

            // Check bounds
            const finalX = Math.max(0, Math.min(level.gridSize - 1, newX));
            const finalY = Math.max(0, Math.min(level.gridSize - 1, newY));

            // Check walls (simple collision)
            const pathClear = !level.walls.some(w => {
                // Check if wall blocks path
                if (forceX !== 0) {
                    const minX = Math.min(gameState.ball.x, finalX);
                    const maxX = Math.max(gameState.ball.x, finalX);
                    if (w.y === gameState.ball.y && w.x > minX && w.x <= maxX) return true;
                }
                if (forceY !== 0) {
                    const minY = Math.min(gameState.ball.y, finalY);
                    const maxY = Math.max(gameState.ball.y, finalY);
                    if (w.x === gameState.ball.x && w.y > minY && w.y <= maxY) return true;
                }
                return false;
            });

            if (pathClear) {
                animateBallMovement(finalX, finalY);
            } else {
                // Hit wall - minimal movement
                renderGrid();
            }
        }

        function animateBallMovement(targetX, targetY) {
            const level = levels[gameState.currentLevel];
            const startX = gameState.ball.x;
            const startY = gameState.ball.y;
            let step = 0;
            const steps = 10;

            const animate = () => {
                step++;
                const progress = step / steps;

                gameState.ball.x = startX + (targetX - startX) * progress;
                gameState.ball.y = startY + (targetY - startY) * progress;

                renderGrid();

                if (step < steps) {
                    requestAnimationFrame(animate);
                } else {
                    gameState.ball.x = targetX;
                    gameState.ball.y = targetY;
                    renderGrid();
                    checkWin();
                }
            };

            animate();
        }

        function checkWin() {
            const level = levels[gameState.currentLevel];

            if (gameState.ball.x === level.goal.x && gameState.ball.y === level.goal.y) {
                // Level complete!
                const stars = gameState.moves <= 1 ? 3 : gameState.moves <= 3 ? 2 : 1;
                const points = stars * 100;
                gameState.score += points;

                document.getElementById('score').textContent = gameState.score;
                document.getElementById('starsDisplay').textContent = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
                document.getElementById('completeText').textContent = `You completed the level in ${gameState.moves} move${gameState.moves > 1 ? 's' : ''}!`;
                document.getElementById('completeFact').innerHTML = `<strong>üî¨ Fun Fact:</strong> ${level.fact}`;

                document.getElementById('completeModal').classList.add('active');

                // Celebration
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => createCelebration(['üß≤', '‚≠ê', 'üéâ'][i % 3]), i * 100);
                }
            }
        }

        function nextLevel() {
            document.getElementById('completeModal').classList.remove('active');

            if (gameState.currentLevel < levels.length - 1) {
                gameState.currentLevel++;
                initLevel();
            } else {
                // Game complete!
                document.getElementById('finalStats').innerHTML = `
                    <strong>Total Score:</strong> ${gameState.score}<br>
                    <strong>Levels Completed:</strong> ${levels.length}
                `;
                document.getElementById('gameCompleteModal').classList.add('active');
            }
        }

        function resetLevel() {
            initLevel();
        }

        function createCelebration(emoji) {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = emoji;
            celebration.style.left = Math.random() * (window.innerWidth - 50) + 'px';
            celebration.style.top = Math.random() * (window.innerHeight - 50) + 'px';
            document.body.appendChild(celebration);
            setTimeout(() => celebration.remove(), 1500);
        }

        function startGame() {
            document.getElementById('startModal').classList.remove('active');
            document.getElementById('gameCompleteModal').classList.remove('active');
            gameState.currentLevel = 0;
            gameState.score = 0;
            initLevel();
        }

        // Initialize on load
        window.onload = () => {
            initLevel();
        };
    </script>
</body>
</html>
